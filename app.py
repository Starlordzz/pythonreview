import streamlit as st  # Web åº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿæ„å»ºç•Œé¢
from openai import OpenAI  # OpenAI å®˜æ–¹å®¢æˆ·ç«¯åº“
import os  # æ“ä½œç³»ç»Ÿæ¥å£ï¼Œç”¨äºè¯»å–ç¯å¢ƒå˜é‡
from dotenv import load_dotenv  # ç”¨äºåŠ è½½ .env æ–‡ä»¶ä¸­çš„é…ç½®

# ==============================================================================
# Streamlit èŠå¤©æœºå™¨äººï¼šä»£ç å—é€ä¸€å¯¹æ¯” (éæµå¼ vs æµå¼)
# ==============================================================================

# åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡ (å¦‚ API Key)
load_dotenv()

# åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯ï¼Œé…ç½®é˜¿é‡Œäº‘ DashScope æœåŠ¡åœ°å€
client = OpenAI(
    api_key=os.getenv("DASHSCOPE_API_KEY"),
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
)

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ [å¯¹æ¯” 1] é¡µé¢é…ç½®ä¸æ ‡é¢˜                                                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# --- [éæµå¼ç‰ˆæœ¬] (å·²æ³¨é‡Š) ---
# st.set_page_config(page_title="Qwen-Plus Chatbot", page_icon="ğŸ¤–")
# st.title("my Qwen-Plus Chatbot ğŸ¤–")

# --- [æµå¼ç‰ˆæœ¬] (å½“å‰è¿è¡Œ) ---
# è®¾ç½®ç½‘é¡µçš„æ ‡é¢˜å’Œæµè§ˆå™¨æ ‡ç­¾é¡µçš„å°å›¾æ ‡
st.set_page_config(page_title="æµå¼ AI åŠ©æ‰‹", page_icon="âš¡")
# åœ¨é¡µé¢ä¸»è¦åŒºåŸŸæ˜¾ç¤ºå¤§æ ‡é¢˜
st.title("âš¡ æˆ‘çš„æµå¼ AI èŠå¤©å®¤")


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ [å¯¹æ¯” 2] åˆå§‹åŒ–ä¸æ¸…ç©ºé€»è¾‘                                                â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# --- [éæµå¼ç‰ˆæœ¬] (å·²æ³¨é‡Š) ---
# if "messages" not in st.session_state:
#     st.session_state.messages = []
#
# if st.sidebar.button("ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯"):
#     st.session_state.messages = []
#     st.rerun()

# --- [æµå¼ç‰ˆæœ¬] (å½“å‰è¿è¡Œ) ---
# æ£€æŸ¥ session_state (ä¼šè¯çŠ¶æ€) ä¸­æ˜¯å¦æœ‰ "messages" åˆ—è¡¨
# session_state ç±»ä¼¼äºæµè§ˆå™¨çš„ç¼“å­˜ï¼Œç”¨äºåœ¨é¡µé¢åˆ·æ–°æ—¶è®°ä½ä¹‹å‰çš„å¯¹è¯
if "messages" not in st.session_state:
    st.session_state.messages = []

# åœ¨ä¾§è¾¹æ  (Sidebar) æ·»åŠ ä¸€ä¸ªæŒ‰é’®
if st.sidebar.button("ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯"):
    st.session_state.messages = [] # ç‚¹å‡»åæ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
    st.rerun() # å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œè®©æ¸…ç©ºæ“ä½œç«‹å³ç”Ÿæ•ˆ


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ [å¯¹æ¯” 3] æ¸²æŸ“å†å²æ¶ˆæ¯                                                    â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# --- [éæµå¼ç‰ˆæœ¬] (å·²æ³¨é‡Š) ---
# for msg in st.session_state.messages:
#     with st.chat_message(msg["role"]):
#         st.markdown(msg["content"])

# --- [æµå¼ç‰ˆæœ¬] (å½“å‰è¿è¡Œ) ---
# éå† session_state ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œå°†å®ƒä»¬é‡æ–°ç”»åœ¨å±å¹•ä¸Š
# è¿™æ ·ç”¨æˆ·åˆ·æ–°é¡µé¢æˆ–è€…è¾“å…¥æ–°é—®é¢˜åï¼Œæ—§çš„èŠå¤©è®°å½•ä¸ä¼šæ¶ˆå¤±
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ [å¯¹æ¯” 4] æ ¸å¿ƒé€»è¾‘ï¼šè¾“å…¥å¤„ç†ä¸ç”Ÿæˆ                                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# è·å–ç”¨æˆ·è¾“å…¥æ¡†çš„å†…å®¹ï¼Œå¦‚æœç”¨æˆ·æŒ‰ä¸‹äº†å›è½¦å‘é€ï¼Œprompt å°±æœ‰å€¼äº†
if prompt := st.chat_input("è¯´ç‚¹ä»€ä¹ˆ..."):

    # === ç”¨æˆ·è¾“å…¥éƒ¨åˆ† (åŸºæœ¬ç›¸åŒ) ===
    # 1. åœ¨ç•Œé¢ä¸Šç«‹å³æ˜¾ç¤ºç”¨æˆ·è¯´çš„è¯
    with st.chat_message("user"):
        st.markdown(prompt)
    # 2. å°†ç”¨æˆ·çš„è¯å­˜å…¥å†å²è®°å½•åˆ—è¡¨
    st.session_state.messages.append({"role": "user", "content": prompt})

    # === AI ç”Ÿæˆéƒ¨åˆ† (æ ¸å¿ƒå·®å¼‚) ===

    # -----------------------------------------------------------------------
    #  A. éæµå¼å“åº”é€»è¾‘ (å·²æ³¨é‡Š/ä»…ä¾›å‚è€ƒ)
    # -----------------------------------------------------------------------
    """
    # [è®²è§£] éæµå¼é€»è¾‘ç‰¹ç‚¹ï¼š
    # 1. é˜»å¡ç­‰å¾…ï¼šç¨‹åºä¼šå¡åœ¨ client.chat.completions.create è¿™ä¸€è¡Œï¼Œç›´åˆ° AI æƒ³å¥½æ‰€æœ‰å­—ã€‚
    # 2. ä½“éªŒè¾ƒå·®ï¼šå¦‚æœå›ç­”å¾ˆé•¿ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ç©ºç™½å±å¹•è½¬åœˆåœˆã€‚
    
    # 1. ä¸€æ¬¡æ€§è¯·æ±‚ API
    response = client.chat.completions.create(
        model="qwen-plus",
        messages=st.session_state.messages
    )

    # 2. ç­‰å¾…å…¨éƒ¨ç”Ÿæˆå®Œæ¯•åè·å–å†…å®¹
    ai_msg = response.choices[0].message.content

    # 3. ä¸€æ¬¡æ€§æ˜¾ç¤º
    with st.chat_message("assistant"):
        st.markdown(ai_msg)
    
    # 4. å­˜å…¥å†å²
    st.session_state.messages.append({"role": "assistant", "content": ai_msg})
    """

    # -----------------------------------------------------------------------
    #  B. æµå¼å“åº”é€»è¾‘ (å½“å‰è¿è¡Œ)
    # -----------------------------------------------------------------------
    with st.chat_message("assistant"):
        # [è®²è§£] æµå¼é€»è¾‘ç‰¹ç‚¹ï¼š
        # 1. å®æ—¶åé¦ˆï¼šAI æƒ³åˆ°ä¸€ä¸ªå­—å°±åå‡ºä¸€ä¸ªå­—ã€‚
        # 2. è§†è§‰æ•ˆæœï¼šä½¿ç”¨ st.empty() å ä½ï¼Œä¸æ–­åˆ·æ–°å†…å®¹ï¼Œæ¨¡æ‹Ÿæ‰“å­—æœºæ•ˆæœã€‚

        # 1. åˆ›å»ºå ä½ç¬¦ï¼šå…ˆåœ¨ç•Œé¢ä¸Šå ä¸ªä½ç½®ï¼Œå‡†å¤‡æ”¾ AI çš„å›ç­”
        message_placeholder = st.empty()
        full_response = ""

        # 2. å¼€å¯æµå¼æ¨¡å¼ (stream=True)ï¼š
        # æ­¤æ—¶è¿”å›çš„ stream æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œé‡Œé¢åŒ…å«äº†ä¸€è¿ä¸²çš„æ•°æ®ç¢ç‰‡
        stream = client.chat.completions.create(
            model="qwen-plus",
            messages=st.session_state.messages,
            stream=True
        )

        # 3. å¾ªç¯æ¥æ”¶ç¢ç‰‡å¹¶å®æ—¶æ›´æ–°
        for chunk in stream:
            # æ£€æŸ¥å½“å‰ç¢ç‰‡é‡Œæœ‰æ²¡æœ‰å†…å®¹ (æ³¨æ„ï¼šæµå¼æ¨¡å¼ä¸‹å†…å®¹åœ¨ delta.content é‡Œ)
            if chunk.choices[0].delta.content is not None:
                content = chunk.choices[0].delta.content
                full_response += content
                # å®æ—¶åˆ·æ–°ï¼šæŠŠç›®å‰æ”¶åˆ°çš„æ‰€æœ‰å­—æ‹¼èµ·æ¥ï¼ŒåŠ ä¸ªå…‰æ ‡ "â–Œ" æ˜¾ç¤ºåœ¨å ä½ç¬¦é‡Œ
                message_placeholder.markdown(full_response + "â–Œ")

        # 4. æœ€ç»ˆæ˜¾ç¤ºï¼šå¾ªç¯ç»“æŸåï¼ŒæŠŠæœ€åé‚£ä¸ªå…‰æ ‡åˆ æ‰ï¼Œæ˜¾ç¤ºå®Œæ•´çš„å¹²å‡€æ–‡æœ¬
        message_placeholder.markdown(full_response)

    # 5. å­˜å…¥å†å²ï¼šæŠŠ AI æœ€ç»ˆå®Œæ•´çš„å›ç­”å­˜å…¥ session_state
    st.session_state.messages.append({"role": "assistant", "content": full_response})